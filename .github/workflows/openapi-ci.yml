name: OpenAPI
on: [pull_request]
jobs:
  preview:
    name: Build & Preview
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - uses: actions/setup-node@v3
        with:
          cache: 'yarn'
          node-version: '16.x.x'

      - name: Boostrap Yarn / Lerna
        run: |
          yarn --frozen-lockfile
          lerna bootstrap --ci

      - uses: 8BitJonny/gh-get-current-pr@2.2.0
        id: pull-request
        with:
          sha: ${{ github.head_ref }}

      - name: Get Lerna Current Version
        id: lerna-current
        run: |
          echo "version=$(grep -m1 version lerna.json | awk -F: '{ print $2 }' | sed 's/[", ]//g')" >> $GITHUB_OUTPUT

      - name: Set outputs
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Version Packages - Dry Run
        run: |
          git config --global user.email "${GITHUB_ACTOR}"
          git config --global user.name "${GITHUB_ACTOR}@users.noreply.github.com"

          yarn lerna version minor \
          --yes \
          --no-push \
          --no-git-tag-version \
          --allow-branch ${{ github.head_ref }}

      - name: Get Lerna Next Version
        id: lerna-next
        run: |
          echo "version=$(grep -m1 version lerna.json | awk -F: '{ print $2 }' | sed 's/[", ]//g')" >> $GITHUB_OUTPUT

      - name: Build OpenAPI Module
        run: yarn lerna run build

      - name: Readme.io - Check for Existing Version
        run: |
          curl https://dash.readme.com/api/v1/version/${{ steps.lerna-next.outputs.version }}-rc.pr-${{ steps.pull-request.outputs.number }} \
          -X GET \
          -u "${{ secrets.READMEIO_API_KEY }}:" > response.json

      - name: Readme.io - Get Project ID
        id: project
        run: echo "id=$(jq '._id' response.json)" >> $GITHUB_OUTPUT

      - name: Readme.io - Create Version
        if: steps.project.outputs.id == ''
        run: |
          yarn rdme versions:create ${{ steps.lerna-next.outputs.version }}-rc.pr-${{ steps.pull-request.outputs.number }} \
          --main=false \
          --beta=false \
          --isPublic=false \
          --key=${{ secrets.READMEIO_API_KEY }} \
          --codename=${{ steps.lerna-next.outputs.version }}-pr#${{ steps.pull-request.outputs.number }} \
          --fork=${{ steps.lerna-current.outputs.version }}

      - name: Readme.io - Create OpenAPI Spec
        if: steps.project.outputs.id == ''
        run: |
          yarn rdme openapi ./openapi/packages/openapi/openapi.json \
          --version=${{ steps.lerna-next.outputs.version }}-rc.pr-${{ steps.pull-request.outputs.number }} \
          --key=${{ secrets.READMEIO_API_KEY }} \
          --create

      - name: Readme.io - Update OpenAPI Spec
        if: steps.project.outputs.id != ''
        run: |
          yarn rdme openapi ./openapi/packages/openapi/openapi.json \
          --version=${{ steps.lerna-next.outputs.version }}-rc.pr-${{ steps.pull-request.outputs.number }} \
          --key=${{ secrets.READMEIO_API_KEY }} \
          --id=${{ steps.project.outputs.id }}

      - name: Create PR Comment
        if: steps.pull-request.outputs.pr_found == 'true' && failure() && steps.version-exists.outcome == 'failure'
        uses: actions-ecosystem/action-create-comment@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.pull-request.outputs.number }}
          body: |
            *Readme.io docs preview environment is ready (v${{ steps.lerna-next.outputs.version }}-${{ steps.vars.outputs.sha_short }})* \
            :books: [Watch Docs](https://balance-test.readme.io/${{ steps.lerna-next.outputs.version }}-rc.pr-${{ steps.pull-request.outputs.number }}/reference).

      - name: Add Github Check
        if: steps.pull-request.outputs.pr_found == 'true' && failure() && steps.version-exists.outcome == 'failure'
        uses: Sibz/github-status-action@v1
        with:
          authToken: ${{ secrets.GITHUB_TOKEN }}
          context: 'Readme.io'
          description: 'âœ… OpenAPI docs preview environment is ready'
          state: 'success'
          sha: ${{ github.event.pull_request.head.sha || github.sha }}
          target_url: https://balance-test.readme.io/${{ steps.lerna-next.outputs.version }}-rc.pr-${{ steps.pull-request.outputs.number }}/reference
