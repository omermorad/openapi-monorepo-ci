name: Release OpenAPI Stable Version

env:
  FRONTEGG_CLIENT_ID: ${{ secrets.FRONTEGG_CLIENT_ID_DEV }}
  FRONTEGG_API_KEY: ${{ secrets.FRONTEGG_API_KEY_DEV }}
  NODE_ENV: 'development'
  APPLICATION_MODE: 'api'
  OPENAPI_FOLDER: 'openapi-specs'

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
        description: Fork from Version (e.g. "1.2")

jobs:
  export-openapi-spec:
    name: Export OpenAPI Spec
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.DEV_AWS_SECRET_ID }}
          aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v3
        with:
          cache: 'yarn'

      - name: 'Authenticate with GitHub Packages'
        run: yarn auth
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Yarn Install
        run: |
          yarn install --frozen-lockfile
          yarn add -D rdme conventional-changelog-cli

      - name: Create Env
        run: |
          cp ./development.env.template ./development.env
          docker-compose up -d db redis stripe

      - name: Export OpenAPI Spec File
        run: yarn ts-node -r tsconfig-paths/register src/openapi-spec.exporter.ts

      - name: OpenAPI Spec Artifact
        uses: actions/upload-artifact@v3
        with:
          name: openapi-spec-${{ github.sha }}
          path: openapi-spec.json

      - name: Set Outputs
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "next_version=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: Store OpenAPI Spec Artifact (S3)
        uses: jakejarvis/s3-sync-action@master
        env:
          AWS_S3_BUCKET: 'openapi-spec-artifacts'
          AWS_ACCESS_KEY_ID: ${{ secrets.DEV_AWS_SECRET_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          SOURCE_DIR: 'openapi-specs'
          DEST_DIR: ${{ steps.vars.outputs.next_version }}

      - name: Push Tag
        run: |
          git tag -a openapi_${{ steps.vars.outputs.next_version }} -m "${{ steps.vars.outputs.next_version }}: PR #${{ steps.get-merged-pull-request.outputs.number }} ${{ steps.get-merged-pull-request.outputs.title }}"
          git push --tags origin "openapi_${{ steps.vars.outputs.next_version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Changelog
        id: release-notes
        run: |
          yarn conventional-changelog -t openapi -p angular -i CHANGELOG.md -s --commit-path ./src/balance-openapi
          
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_REPOSITORY: blnce-io/backend

      - name: Sync OpenAPI Spec to Readme.io
        run: yarn rdme openapi openapi-spec.json --id=6380d889f0dc510819e9977c --key=${{ secrets.READMEIO_API_KEY }}
